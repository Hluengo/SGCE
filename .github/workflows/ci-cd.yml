name: Quality Gate - Regression + E2E + Performance

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      run_mode:
        description: 'Execution mode'
        required: true
        default: 'performance-only'
        type: choice
        options:
          - performance-only
          - full-quality-gate
  schedule:
    # Every day at 03:00 America/Santiago equivalent in UTC (06:00 UTC, may vary with DST)
    - cron: '0 6 * * *'

concurrency:
  group: quality-gate-${{ github.ref }}
  cancel-in-progress: true

jobs:
  regression:
    runs-on: ubuntu-latest
    if: >
      github.event_name != 'schedule' &&
      (github.event_name != 'workflow_dispatch' || inputs.run_mode == 'full-quality-gate')

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run regression tests (Vitest)
      run: npm run test:run

  e2e:
    runs-on: ubuntu-latest
    if: >
      github.event_name != 'schedule' &&
      (github.event_name != 'workflow_dispatch' || inputs.run_mode == 'full-quality-gate')

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Install Playwright browsers
      run: npx playwright install --with-deps chromium firefox webkit

    - name: Run E2E tests
      run: npm run test:e2e:run
      env:
        VITE_E2E_MOCK_AUTH: true

    - name: Upload E2E artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: e2e-artifacts
        path: |
          test-results/
          playwright-report/
        if-no-files-found: warn

  performance:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Install Playwright browsers
      run: npx playwright install --with-deps chromium

    - name: Run Playwright performance tests
      run: npm run test:performance
      env:
        VITE_E2E_MOCK_AUTH: true

    - name: Run Lighthouse CI
      run: |
        npm install -g @lhci/cli
        lhci autorun
      env:
        CI: true
        VITE_E2E_MOCK_AUTH: true

    - name: Upload Lighthouse results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: lighthouse-results
        path: .lighthouseci/
        if-no-files-found: warn

  quality-gate:
    runs-on: ubuntu-latest
    needs: [regression, e2e, performance]
    if: >
      github.event_name != 'schedule' &&
      (github.event_name != 'workflow_dispatch' || inputs.run_mode == 'full-quality-gate')

    steps:
    - name: Gate status
      run: echo "Regression + E2E + Performance passed."
